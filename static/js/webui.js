"use-strict";function addRefreshableEventListener(root,targetSelector,type,listener,options){function rebindListener(mutations){for(let mutation of mutations)for(let node of mutation.addedNodes){if(!(node instanceof HTMLElement))return;node.matches(targetSelector)&&node.addEventListener(type,listener,options);for(let child of node.querySelectorAll(targetSelector))child instanceof HTMLElement&&child.addEventListener(type,listener,options)}}let observer=new MutationObserver(rebindListener);return observer.observe(root,{subtree:!0,childList:!0}),observer}var AsyncFunction=(async function(){}).constructor;var WebuiBridge=class{#secure;#token;#port;#log;#winX;#winY;#winW;#winH;#customWindowDrag;#enableCustomDragging=!1;#isDragging=!1;#initialMouseX=0;#initialMouseY=0;#initialWindowX=window.screenX||window.screenLeft;#initialWindowY=window.screenY||window.screenTop;#currentWindowX=window.screenX||window.screenLeft;#currentWindowY=window.screenY||window.screenTop;#ws;#wsStayAlive=!0;#wsStayAliveTimeout=500;#wsWasConnected=!1;#TokenAccepted=!1;#closeReason=0;#closeValue;#AllEvents=!1;#callPromiseID=new Uint16Array(1);#callPromiseResolve=[];#allowNavigation=!0;#sendQueue=[];#isSending=!1;#bindsList;#WEBUI_SIGNATURE=221;#CMD_JS=254;#CMD_JS_QUICK=253;#CMD_CLICK=252;#CMD_NAVIGATION=251;#CMD_CLOSE=250;#CMD_CALL_FUNC=249;#CMD_SEND_RAW=248;#CMD_NEW_ID=247;#CMD_MULTI=246;#CMD_CHECK_TK=245;#CMD_WINDOW_DRAG=244;#CMD_WINDOW_RESIZED=243;#MULTI_CHUNK_SIZE=65500;#PROTOCOL_SIZE=8;#PROTOCOL_SIGN=0;#PROTOCOL_TOKEN=1;#PROTOCOL_ID=5;#PROTOCOL_CMD=7;#PROTOCOL_DATA=8;#Token=new Uint32Array(1);#Ping=!0;#eventsCallback=null;#lastEvent=-1;event={CONNECTED:0,DISCONNECTED:1};constructor({secure=!1,token=0,port=0,log=!1,winX=0,winY=0,winW=0,winH=0,customWindowDrag=!1}){if(this.#secure=secure,this.#token=token,this.#port=port,this.#log=log,this.#winX=winX,this.#winY=winY,this.#winW=winW,this.#winH=winH,this.#enableCustomDragging=customWindowDrag,this.#Token[0]=this.#token,"webui"in globalThis)throw new Error("Sorry. WebUI is already defined, only one instance is allowed.");this.#winX!==void 0&&this.#winY,this.#winW!==void 0&&this.#winH,"WebSocket"in window||(this.#showWarning("WebSocket is not supported by your web browser"),this.#log||globalThis.close()),this.#start(),"navigation"in globalThis?globalThis.navigation.addEventListener("navigate",event=>{if(!this.#allowNavigation&&this.#AllEvents&&this.#wsIsConnected()){event.preventDefault();let url=new URL(event.destination.url);this.#log&&console.log(`WebUI -> DOM -> Navigation Event [${url.href}]`),this.#sendEventNavigation(url.href)}}):addRefreshableEventListener(document.body,"a","click",event=>{if(!this.#allowNavigation&&this.#AllEvents&&this.#wsIsConnected()){event.preventDefault();let{href}=event.target;this.#log&&console.log(`WebUI -> DOM -> Navigation Click Event [${href}]`),this.#sendEventNavigation(href)}}),document.addEventListener("keydown",event=>{this.#log||event.key==="F5"&&event.preventDefault()}),this.#enableCustomDragging&&(document.addEventListener("mousemove",e=>{if(e.buttons!==1){this.#isDragging=!1;return}if(!this.#isDragging){let target=e.target;for(;target;){if(window.getComputedStyle(target).getPropertyValue("--webui-app-region").trim()==="drag"){this.#initialMouseX=e.screenX,this.#initialMouseY=e.screenY,this.#initialWindowX=this.#currentWindowX,this.#initialWindowY=this.#currentWindowY,this.#isDragging=!0;break}target=target.parentElement}return}let deltaX=e.screenX-this.#initialMouseX,deltaY=e.screenY-this.#initialMouseY,newX=this.#initialWindowX+deltaX,newY=this.#initialWindowY+deltaY;newX<0&&(newX=0),newY<0&&(newY=0),this.#sendDrag(newX,newY),this.#currentWindowX=newX,this.#currentWindowY=newY}),document.addEventListener("mouseup",()=>{this.#isDragging=!1})),onbeforeunload=()=>{this.#close()},setTimeout(()=>{this.#wsWasConnected||this.#showWarning("Failed to connect to the backend application")},5e3)}#close(reason=0,value=""){this.#closeReason=reason,this.#closeValue=value,this.#wsIsConnected()&&this.#ws.close()}#showWarning(msg){setTimeout(()=>{if(!this.#wsIsConnected()){if(document.getElementById("webui-error-connection-lost"))return;let div=document.createElement("div");div.id="webui-error-connection-lost",Object.assign(div.style,{position:"fixed",top:"0",left:"0",width:"100%",backgroundColor:"rgb(191 125 30 / 84%)",color:"#fff",textAlign:"center",padding:"4px 0",fontFamily:"Arial, sans-serif",fontSize:"16px",zIndex:"9000",lineHeight:"1"}),div.innerHTML="<strong>Error:</strong> "+msg+" - <em>WebUI 2.5.0-beta.4</em>",document.body.insertBefore(div,document.body.firstChild)}},1e3)}#freezeUi(){this.#eventsCallback==null&&this.#showWarning("Connection with the backend is lost")}#unfreezeUI(){let div=document.getElementById("webui-error-connection-lost");div&&div.remove()}#isTextBasedCommand(cmd){return cmd!==this.#CMD_SEND_RAW}#parseDimensions(input){try{let parts=input.split(",");if(parts.length!==4)return{x:0,y:0,width:0,height:0};let x=parseFloat(parts[0]),y=parseFloat(parts[1]),width=parseFloat(parts[2]),height=parseFloat(parts[3]);return[x,y,width,height].some(isNaN)?{x:0,y:0,width:0,height:0}:{x,y,width,height}}catch{return{x:0,y:0,width:0,height:0}}}#getDataStrFromPacket(buffer,startIndex){let stringBytes=[];for(let i=startIndex;i<buffer.length&&buffer[i]!==0;i++)stringBytes.push(buffer[i]);return new TextDecoder().decode(new Uint8Array(stringBytes))}#getID(buffer,index){if(index<0||index>=buffer.length-1)throw new Error("Index out of bounds or insufficient data.");let firstByte=buffer[index];return buffer[index+1]<<8|firstByte}#addToken(buffer,value,index){if(value<0||value>4294967295)throw new Error("Number is out of the range for 4 bytes representation.");if(index<0||index>buffer.length-4)throw new Error("Index out of bounds or insufficient space in buffer.");buffer[index]=value&255,buffer[index+1]=value>>>8&255,buffer[index+2]=value>>>16&255,buffer[index+3]=value>>>24&255}#addID(buffer,value,index){if(value<0||value>65535)throw new Error("Number is out of the range for 2 bytes representation.");if(index<0||index>buffer.length-2)throw new Error("Index out of bounds or insufficient space in buffer.");buffer[index]=value&255,buffer[index+1]=value>>>8&255}#start(){this.#keepAlive(),this.#callPromiseID[0]=0,this.#wsConnect()}#keepAlive=async()=>{for(;;)this.#Ping?this.#sendData(new TextEncoder().encode("ping")):this.#Ping=!0,await new Promise(resolve=>setTimeout(resolve,2e4))};#clicksListener(){document.querySelectorAll("[id]").forEach(e=>{(this.#AllEvents||e.id!==""&&this.#bindsList.includes(e.id))&&e.id&&!e.dataset.webui_click_is_set&&(e.dataset.webui_click_is_set="true",e.addEventListener("click",()=>this.#sendClick(e.id)))})}async#sendData(packet){if(this.#Ping=!1,!(!this.#wsIsConnected()||packet===void 0)&&(this.#sendQueue.push(packet),!this.#isSending)){for(this.#isSending=!0;this.#sendQueue.length>0;){let currentPacket=this.#sendQueue.shift();if(currentPacket.length<this.#MULTI_CHUNK_SIZE)this.#ws.send(currentPacket.buffer);else{let pre_packet=Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_MULTI,...new TextEncoder().encode(currentPacket.length.toString()),0);this.#ws.send(pre_packet.buffer);let offset=0,sendChunk=async()=>{if(offset<currentPacket.length){let chunkSize=Math.min(this.#MULTI_CHUNK_SIZE,currentPacket.length-offset),chunk=currentPacket.subarray(offset,offset+chunkSize);this.#ws.send(chunk),offset+=chunkSize,await sendChunk()}};await sendChunk()}}this.#isSending=!1}}#sendClick(elem){if(this.#wsIsConnected()){let packet=elem!==""?Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_CLICK,...new TextEncoder().encode(elem),0):Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_CLICK,0);this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#sendData(packet),this.#log&&console.log(`WebUI -> Send Click [${elem}]`)}}#checkToken(){if(this.#wsIsConnected()){let packet=Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_CHECK_TK,0);this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#sendData(packet),this.#log&&console.log(`WebUI -> Send Token [0x${this.#token.toString(16).padStart(8,"0")}]`)}}#sendEventNavigation(url){if(url!==""&&this.#wsIsConnected()){this.#log&&console.log(`WebUI -> Send Navigation Event [${url}]`);let packet=Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_NAVIGATION,...new TextEncoder().encode(url));this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#sendData(packet)}}#sendDrag(x,y){if(this.#wsIsConnected()){this.#log&&console.log(`WebUI -> Send Drag Event [${x}, ${y}]`);let packet=Uint8Array.of(this.#WEBUI_SIGNATURE,0,0,0,0,0,0,this.#CMD_WINDOW_DRAG,...new Uint8Array(new Int32Array([x]).buffer),...new Uint8Array(new Int32Array([y]).buffer));this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#sendData(packet)}}#closeWindowTimer(){setTimeout(function(){globalThis.close()},1e3)}#updateBindsList(){this.#bindsList.includes("")&&(this.#AllEvents=!0,this.#allowNavigation=!1),this.#generateCallObjects(),this.#clicksListener()}#toUint16(value){return value&65535}#generateCallObjects(){for(let bind of this.#bindsList)if(bind.trim()){let fn=bind;fn.trim()&&fn!=="__webui_core_api__"&&typeof window[fn]>"u"&&(this[fn]=(...args)=>this.call(fn,...args),window[fn]=(...args)=>this.call(fn,...args),this.#log&&console.log(`WebUI -> Binding backend function [${fn}]`))}}#getScriptUrl(){let scripts=Array.from(document.scripts).filter(s=>s.src!==null&&s.src.startsWith("http")&&s.src.endsWith("webui.js")).map(s=>s.src);return scripts.length===0?null:new URL(scripts[0])}#callPromise(fn,...args){--this.#callPromiseID[0];let callId=this.#toUint16(this.#callPromiseID[0]),argsLengths=args.map(arg=>typeof arg=="object"?arg.length:new TextEncoder().encode(arg.toString()).length).join(";"),argsValues=new Uint8Array;for(let arg of args){let buffer;typeof arg=="object"?buffer=arg:buffer=new TextEncoder().encode(arg.toString());let temp=new Uint8Array(argsValues.length+buffer.length+1);temp.set(argsValues,0),temp.set(buffer,argsValues.length),temp[argsValues.length+buffer.length]=0,argsValues=temp}let packet=new Uint8Array(0),packetPush=data=>{let newPacket=new Uint8Array(packet.length+data.length);newPacket.set(packet),newPacket.set(data,packet.length),packet=newPacket};return packetPush(new Uint8Array([this.#WEBUI_SIGNATURE])),packetPush(new Uint8Array([0,0,0,0])),packetPush(new Uint8Array([0,0])),packetPush(new Uint8Array([this.#CMD_CALL_FUNC])),packetPush(new TextEncoder().encode(fn)),packetPush(new Uint8Array([0])),packetPush(new TextEncoder().encode(argsLengths)),packetPush(new Uint8Array([0])),packetPush(new Uint8Array(argsValues)),this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#addID(packet,callId,this.#PROTOCOL_ID),new Promise(resolve=>{this.#callPromiseResolve[callId]=resolve,this.#sendData(packet)})}async callCore(fn,...args){return this.call("__webui_core_api__",fn,...args)}#wsIsConnected(){return this.#ws&&this.#ws.readyState===WebSocket.OPEN}#wsConnect(){this.#wsIsConnected()&&this.#ws.close(),this.#TokenAccepted=!1;let scriptUrl=this.#getScriptUrl(),host=scriptUrl!==null?scriptUrl.hostname:window.location.hostname,url=this.#secure?"wss://"+host:"ws://"+host;this.#ws=new WebSocket(`${url}:${this.#port}/_webui_ws_connect`),this.#ws.binaryType="arraybuffer",this.#ws.onopen=this.#wsOnOpen.bind(this),this.#ws.onmessage=this.#wsOnMessage.bind(this),this.#ws.onclose=this.#wsOnClose.bind(this),this.#ws.onerror=this.#wsOnError.bind(this)}#wsOnOpen=event=>{this.#wsWasConnected=!0,this.#unfreezeUI(),this.#log&&console.log("WebUI -> Connected"),this.#checkToken()};#wsOnError=event=>{this.#log&&console.log("WebUI -> Connection failed.")};#wsOnClose=event=>{this.#closeReason===this.#CMD_NAVIGATION?(this.#closeReason=0,this.#log&&console.log(`WebUI -> Connection lost. Navigation to [${this.#closeValue}]`),this.#allowNavigation=!0,globalThis.location.replace(this.#closeValue)):this.#wsStayAlive?(this.#log&&console.log(`WebUI -> Connection lost (${event.code}). Reconnecting...`),this.#freezeUi(),setTimeout(()=>this.#wsConnect(),this.#wsStayAliveTimeout)):this.#log?(console.log(`WebUI -> Connection lost (${event.code})`),this.#freezeUi()):this.#closeWindowTimer(),this.#userEventCallback(this.event.DISCONNECTED)};#userEventCallback=e=>{this.#eventsCallback&&e!=this.#lastEvent&&(this.#lastEvent=e,this.#eventsCallback(e))};#wsOnMessage=async event=>{var _a,_b;let buffer8=new Uint8Array(event.data);if(!(buffer8.length<this.#PROTOCOL_SIZE)&&buffer8[this.#PROTOCOL_SIGN]===this.#WEBUI_SIGNATURE){if(this.#isTextBasedCommand(buffer8[this.#PROTOCOL_CMD])){let callId=this.#getID(buffer8,this.#PROTOCOL_ID);switch(buffer8[this.#PROTOCOL_CMD]){case this.#CMD_JS_QUICK:case this.#CMD_JS:{let scriptSanitize=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA).replace(/(?:\r\n|\r|\n)/g,`
`);this.#log&&console.log(`WebUI -> CMD -> JS [${scriptSanitize}]`);let FunReturn="undefined",FunError=!1,isBinaryReturn=!1;try{let result=await AsyncFunction(scriptSanitize)();result instanceof Uint8Array?(FunReturn=result,isBinaryReturn=!0):FunReturn=String(result)}catch(e){FunError=!0,FunReturn=e.message}if(buffer8[this.#PROTOCOL_CMD]===this.#CMD_JS_QUICK)return;if(FunReturn===void 0&&(FunReturn="undefined"),this.#log&&!FunError)if(isBinaryReturn){let binaryData=FunReturn,hexPreview=Array.from(binaryData.slice(0,64)).map(b=>`0x${b.toString(16).padStart(2,"0")}`).join(", ");console.log(`WebUI -> CMD -> JS -> Return Success (${binaryData.length} Bytes) [${hexPreview}${binaryData.length>64?"...":""}]`)}else{let stringData=String(FunReturn);console.log(`WebUI -> CMD -> JS -> Return Success (${new TextEncoder().encode(stringData).length} Bytes) [${stringData.substring(0,64)}${stringData.length>64?"...":""}]`)}else if(this.#log&&FunError){let errorString=String(FunReturn);console.log(`WebUI -> CMD -> JS -> Return Error [${errorString.substring(0,64)}${errorString.length>64?"...":""}]`)}let packet=new Uint8Array(0),packetPush=data=>{let newPacket=new Uint8Array(packet.length+data.length);newPacket.set(packet),newPacket.set(data,packet.length),packet=newPacket},packetPushStr=data=>{if(data.length>8192){let encoder=new TextEncoder;for(let i=0;i<data.length;i+=8192){let chunk=data.substring(i,Math.min(i+8192,data.length)),encodedChunk=encoder.encode(chunk);packetPush(encodedChunk)}}else packetPush(new TextEncoder().encode(data))};packetPush(new Uint8Array([this.#WEBUI_SIGNATURE])),packetPush(new Uint8Array([0,0,0,0])),packetPush(new Uint8Array([0,0])),packetPush(new Uint8Array([this.#CMD_JS])),packetPush(new Uint8Array(FunError?[1]:[0])),isBinaryReturn?packetPush(FunReturn):packetPushStr(FunReturn),packetPush(new Uint8Array([0])),this.#addToken(packet,this.#token,this.#PROTOCOL_TOKEN),this.#addID(packet,callId,this.#PROTOCOL_ID),this.#sendData(packet)}break;case this.#CMD_CALL_FUNC:{let callResponse=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA);this.#log&&console.log(`WebUI -> CMD -> Call Response [${callResponse}]`),this.#callPromiseResolve[callId]&&(this.#log&&console.log(`WebUI -> CMD -> Resolving Response #${callId}...`),(_b=(_a=this.#callPromiseResolve)[callId])==null||_b.call(_a,callResponse),this.#callPromiseResolve[callId]=void 0)}break;case this.#CMD_NAVIGATION:let url=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA);this.#log&&console.log(`WebUI -> CMD -> Navigation [${url}]`),this.#close(this.#CMD_NAVIGATION,url);break;case this.#CMD_WINDOW_RESIZED:let widthAndHeight=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA),{x,y,width,height}=this.#parseDimensions(widthAndHeight);this.#currentWindowX=x,this.#currentWindowY=y,this.#log&&console.log(`WebUI -> CMD -> Window Resized [x: ${x}, y: ${y}, width: ${width}, height: ${height}]`);break;case this.#CMD_NEW_ID:let newElement=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA);this.#log&&console.log(`WebUI -> CMD -> New Bind ID [${newElement}]`),this.#bindsList.includes(newElement)||this.#bindsList.push(newElement),this.#updateBindsList();break;case this.#CMD_CLOSE:this.#log?(console.log("WebUI -> CMD -> Close"),this.#wsIsConnected()&&(this.#wsStayAlive=!1,this.#ws.close())):globalThis.close();break;case this.#CMD_CHECK_TK:let status=buffer8[this.#PROTOCOL_DATA]!=0,tokenHex=`0x${this.#token.toString(16).padStart(8,"0")}`;if(status){this.#log&&console.log(`WebUI -> CMD -> Token [${tokenHex}] Accepted`),this.#TokenAccepted=!0;let csv=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA+1);csv=csv.endsWith(",")?csv.slice(0,-1):csv,this.#bindsList=csv.split(","),this.#updateBindsList(),this.#userEventCallback(this.event.CONNECTED)}else this.#log&&console.log(`WebUI -> CMD -> Token [${tokenHex}] Not Accepted. Reload page...`),this.#allowNavigation=!0,this.#wsStayAlive=!1,globalThis.location.reload();break}}else if(buffer8[this.#PROTOCOL_CMD]===this.#CMD_SEND_RAW){let functionName=this.#getDataStrFromPacket(buffer8,this.#PROTOCOL_DATA),rawDataIndex=this.#PROTOCOL_DATA+functionName.length+1,rawDataSize=buffer8.length-rawDataIndex-1,userRawData=buffer8.subarray(rawDataIndex,rawDataIndex+rawDataSize);this.#log&&console.log(`WebUI -> CMD -> Received Raw ${rawDataSize} bytes for [${functionName}()]`),typeof window[functionName]=="function"?window[functionName](userRawData):await AsyncFunction(functionName+"(userRawData)")()}}};async call(fn,...args){if(!fn)return Promise.reject(new SyntaxError("No binding name is provided"));if(!this.#wsIsConnected())return Promise.reject(new Error("WebSocket is not connected"));if(fn!=="__webui_core_api__"&&!this.#AllEvents&&!this.#bindsList.includes(`${fn}`))return Promise.reject(new ReferenceError(`No binding was found for "${fn}"`));this.#log&&console.log(`WebUI -> Calling [${fn}(...)]`);let response=await this.#callPromise(fn,...args);return typeof response!="string"?"":response}setLogging(status){status?(console.log("WebUI -> Log Enabled."),this.#log=!0):(console.log("WebUI -> Log Disabled."),this.#log=!1)}encode(data){return btoa(data)}decode(data){return atob(data)}setEventCallback(callback){this.#eventsCallback=callback}isConnected(){return this.#wsIsConnected()&&this.#TokenAccepted}async isHighContrast(){let response=await this.callCore("high_contrast");return this.#log&&console.log(`Core Response: [${response}]`),response}allowNavigation(status){this.#allowNavigation=status}};addEventListener("load",()=>{document.body.addEventListener("contextmenu",event=>event.preventDefault()),addRefreshableEventListener(document.body,"input","contextmenu",event=>event.stopPropagation())});
